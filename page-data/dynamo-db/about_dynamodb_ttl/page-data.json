{"componentChunkName":"component---src-template-post-tsx","path":"/dynamo-db/about_dynamodb_ttl/","result":{"data":{"site":{"siteMetadata":{"siteUrl":"https://akasai.space","comment":{"utterances":"akasai/akasai.github.io"}}},"post":{"id":"77e413b3-d3cf-5c5d-9835-adca79ee9f80","excerpt":"주기적으로 캐싱을 해야 하는 작업이 있어 삽질해본 경험을 공유하려 합니다. 단순하게 Crontab이나 배치 등을 이용하여 처리하는 방법과 Request…","timeToRead":3,"html":"<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 260px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 50%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsTAAALEwEAmpwYAAACU0lEQVQoz41P3UvTURh+jppdSJiVYDvnd872cx/5cbFhuVBkc9iH5izL5BczWC5nRtCIDVZmXTjxo6hUsGwhimiZaTeVUiA4Kvu4KBT8S7wQlJ3Y1BK7qAce3veF93ne5wWrjUBXGUKOq5nwhigKb3yArXUBZwaWcTe2Akf7J+KILMBgsUFQBj1VoGcKBFN+93rGNmbGAFbbgewSDTnHA+AN0dKCwGyXNRx74O5balyUMs3V9R3l3T+IpSa8Kf7DrQOJukUIzxMiPIOg7taQUv9QmhqHpKVpVJbfeSddkfn5jPrJzD31E8gBkik2hMpf5lvEAZsLWab8VF1lcJmd7ZRG77NV8+WRtZLQy7Wi68+l8cp0Rd6UhFDEgKCsV1A2JCjr3GS3oOyeoCwqKNOSCTNpNlIBoqsKfVbqeqTRG103+4bjZeGpeHFwShr8r0q4lFD16jWVC4/KxTmVC6/KRZPKhZbLhdco9HUGhRerXAD7C+3Yy2mqrir0VTl/X5p9w+uHmsfjzrY3cXtwWub6Jx1HHq8DSLMCoAD4NmYDKAJQBiATCWQZLUhPJKwMLrHaDpl7cWDV5I2u2QOj8cTLppbXTueMRMqu3ScBVANwAThNQCoIIYnZDaCObBwDuNZPuNYPVtN2gWt9K+amUZnXMiGPRebkiZ4vI7AOpkPxJ3cJISn4Fw5WXIWhcRzUfRvc85QXBGYv2W7Gmk/1LjqYbxql7d9wOPSWbJOQHXWnYQsMvhcJwxTuGUR+YAa2Wx9R/egn9mlj5GjrHIrD75FBC/E/+AVcjLdMKEIh8QAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"dynamodb\"\n        title=\"dynamodb\"\n        src=\"/static/4f92fe577361a25b0c00efa078ed733e/86c28/dynamodb.png\"\n        srcset=\"/static/4f92fe577361a25b0c00efa078ed733e/86c28/dynamodb.png 260w\"\n        sizes=\"(max-width: 260px) 100vw, 260px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p>주기적으로 캐싱을 해야 하는 작업이 있어 삽질해본 경험을 공유하려 합니다.</p>\n<p>단순하게 Crontab이나 배치 등을 이용하여 처리하는 방법과</p>\n<p>Request 단위로 캐싱을 하는 방법을 생각해보았지만, 여러 조건이 존재해서 아래 방법을 선택했습니다.</p>\n<hr>\n<h2 id=\"data-modeling\" style=\"position:relative;\"><a href=\"#data-modeling\" aria-label=\"data modeling permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Data Modeling</h2>\n<p>기존 API의 latency를 줄이기 위한 일부 데이터를 캐싱하는 작업이였기 때문에 스키마를 복잡하게 모델링하진 않았습니다.</p>\n<p>키를 기준으로 Map을 요소로하는 List를 구성하였습니다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 404px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 47%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAABYlAAAWJQFJUiTwAAABoElEQVQoz01SaU/bUBDML6BKfDz7Pd9nHJJAINwEIk5xlUttowJVQer//wlTzRoQH0aW17OzM7vuOI6DIAwRxfE7EkEszxhhFMlT3qNYECfJZ/2jx9catm2h4yqFZnmIIAjh+1rg+T6UUtDaSAPJnufBmAB5UWJ5NEYYRjBBAOV5KKsaRVmh1+2iQyInZkWBq9sHXH6/x6+Xv/jx+wUXN3fYnR3i+e0fru8ecXR6LmkoRJHFn1epG2OQpCmsXg8dTsjyXCZOphsYT9Yw3dzG9t5MnA/HK9jZn2HvYC41CiZpBq01NrZ2sLq2LoJplqNHQdd1MVpZFRInU5hNRJykQgzCqN1dnKA/GGCyPpVv3KM2BoPhCFW/QZeRW4eF7I4x2EiS6yo4jgsejUMJ27bFGYfIjo0RPo2kWdY6bHeYom4aPC6eMD8+xf3PhcT8trT0KURhy7LkUOSXdY35yZnssB3yLqiUJxdiI+PSMePTNQUct3VJiENj5IDky5qMEYfkiyCJeVGIKIt5WUokoqgqqX8F18I0/H14TKLuNxKdBv4DztH+Bi7BtDkAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"lambda table\"\n        title=\"lambda table\"\n        src=\"/static/fb4201c9a5e255f798b508a1d46b6007/494f9/lambda-table.png\"\n        srcset=\"/static/fb4201c9a5e255f798b508a1d46b6007/5a46d/lambda-table.png 300w,\n/static/fb4201c9a5e255f798b508a1d46b6007/494f9/lambda-table.png 404w\"\n        sizes=\"(max-width: 404px) 100vw, 404px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<hr>\n<h2 id=\"storage\" style=\"position:relative;\"><a href=\"#storage\" aria-label=\"storage permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Storage</h2>\n<p>일반적으로 캐싱이라면 NoSQL을 통해 처리하고 있고 현업에서는 <code class=\"language-text\">'Redis</code>, <code class=\"language-text\">DynamoDB</code>를 사용하고 있습니다.</p>\n<p>구상하고 있는 스키마에 적합한 것은 <code class=\"language-text\">DynamoDB</code>라고 판단했습니다.</p>\n<p>Redis 역시 다양한 dataType을 지원하지만 <strong>Map을 요소로 하는 List</strong>를 구성하기엔 DynamoDB가 적합하다고 생각했습니다.</p>\n<hr>\n<h2 id=\"ttl-time-to-live\" style=\"position:relative;\"><a href=\"#ttl-time-to-live\" aria-label=\"ttl time to live permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>TTL (Time To Live)</h2>\n<p>Crontab또는 배치를 사용하지 않고 어떻게 주기적으로 캐싱을 할 것인지가 중요한 포인트였습니다.</p>\n<p>Redis와 DynamoDB 둘 다 TTL 기능을 지원하고 있습니다.</p>\n<p>Redis는 TTL에 대한 evnet를 Subscribe 하는 추가적인 개발이 필요했지만 DynamoDB는 <code class=\"language-text\">Stream Trigger</code>를 이용해 <code class=\"language-text\">Lambda</code>를 호출할 수 있습니다.</p>\n<p>이런 이점들을 고려하여 최종적으로 DynamoDB를 선택하여 개발을 시작했습니다.</p>\n<hr>\n<h2 id=\"dynamodb-세팅\" style=\"position:relative;\"><a href=\"#dynamodb-%EC%84%B8%ED%8C%85\" aria-label=\"dynamodb 세팅 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>DynamoDB 세팅</h2>\n<ol>\n<li>일반적인 세팅과 같이 AWS Console에서 테이블 세팅을 합니다.</li>\n</ol>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1200px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 74.33333333333333%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAABYlAAAWJQFJUiTwAAABxElEQVQ4y5VTSW7cMBDU8/OKXHLMNfmAP5CTDwHiwyzSSDIlauOIm1hGtcBgAAuGTaDRPRx2saqaKvq+R9u2qOs61XWN2+3GvCmlNgAJ+8r5cFlr2YeyLFEopXC9XgmIpmlS0zS4XC5yCWtexJrBJp7XWmOaJgnWJNV1neRinmcMwyBgBNVaj3Vd/1VK/Ru0dmwYhkFA2bSuK2KMh7FtG4pM2xizkbJz7iXG+APAT6Q0pSRq07Is+Mwq2EBkZmNMIm0Ce+8JDmdtYk0lZKv7XvbllpTeRfEALlTmed5Op1OYxik65xKbvffJGAOyvN/vIu8ITBjy1qqqxJu8MuOvLmHIgXCqnF7X9ej7TuTlCY7jKENjcCjMtIXnWYsNWgtzASSbEAK8D4jB46YdyvoVr20jXvH/PEGey5nB/b3XSy2SHw2kSr5mpTqcz2d5m/Qt+0dbWDPnOg/ov+QjLyiBk6YV9JfB3wzK5JeRAVlnMLIqFhsxrgHP1xm//zSIW/rQ9I/2heE4L+j6AVXb46XsxFxrd0mss7x930rk+vGMsyticCjkAVuL4B2whXef0mcixIjBeGgTjj382tvbpX5/qvDt1wlvr7GMwJuQYGIAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"lambda1\"\n        title=\"lambda1\"\n        src=\"/static/e17e4921fbc664202af7c56a3a4d422d/c1b63/lambda1.png\"\n        srcset=\"/static/e17e4921fbc664202af7c56a3a4d422d/5a46d/lambda1.png 300w,\n/static/e17e4921fbc664202af7c56a3a4d422d/0a47e/lambda1.png 600w,\n/static/e17e4921fbc664202af7c56a3a4d422d/c1b63/lambda1.png 1200w,\n/static/e17e4921fbc664202af7c56a3a4d422d/49ee2/lambda1.png 1618w\"\n        sizes=\"(max-width: 1200px) 100vw, 1200px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<ol start=\"2\">\n<li>\n<p>테이블이 생성되면 TTL로 설정하고자 하는 Attribute를 입력한 뒤 TTL을 설정합니다.</p>\n<p>TTL은 반드시 Number타입으로 세팅되어야 합니다.</p>\n</li>\n</ol>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1200px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 62%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAABYlAAAWJQFJUiTwAAAB7ElEQVQoz6WT226bQBCGefg+Tt+g15WatGnr+BTnAAlgdmFZwBhszl+1aztyctuVPv0zO6PZ0TA4Nz/v2Gweubm5xfU84iRBSImU8Yk4RpxtcYX8dBcJwf1iifPn7z15luG+vCBEhNYanaakSpGmKUmSoHVq7ewSsyiLiRlMzPNecWbzBUJInp9fCMIt4Zk3P7Cvvvk+fhAQbiMiIfH9wOYZ9YPQqsm1XccJzt1sga47ZHGg7KBoRkJV4Mc5Mjui9z2qaCkOA1UP+x6rF4xftlANEEQxzq/ZkhrIG8jbE7sOXHVkFlSs5ZGVOLCSR57SlkfVslGttddxw0Pc4GUt2/3E2zbGmS/X9EDdjehdTSAVUaLRZc023eFFmucg4SmIrXpC424VXpTyKjJkfqBqR5oBIpmcZrgvS5RSVPs9x+OBtmkY+p5xONN3DGemobd6uWcaYZowx2yIc79YUZYlUSTI85zdbkeWZSfy/N02XzbPi7OtKYodWmcURWGb6bqORCnT4ZI8z3Bd166MSTCFy3PXYRjaIlVV2bh5sK5rrs943eF8ubJO27YMw8A0TTbBqPE/M46jjV0Dp4J2bdYPj/zvicuORdSQpBrn+49bOyuztOL6V4uTD3qxU529o3Rmx/Xt9ytfvs7ZPLn8A+EBi8XbqXF3AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"lambda2\"\n        title=\"lambda2\"\n        src=\"/static/52ef30463b9847df0c0e1d2661d3a4b4/c1b63/lambda2.png\"\n        srcset=\"/static/52ef30463b9847df0c0e1d2661d3a4b4/5a46d/lambda2.png 300w,\n/static/52ef30463b9847df0c0e1d2661d3a4b4/0a47e/lambda2.png 600w,\n/static/52ef30463b9847df0c0e1d2661d3a4b4/c1b63/lambda2.png 1200w,\n/static/52ef30463b9847df0c0e1d2661d3a4b4/668c6/lambda2.png 1692w\"\n        sizes=\"(max-width: 1200px) 100vw, 1200px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<ol start=\"3\">\n<li>Stream 세팅을 통해 <code class=\"language-text\">ARN</code>을 획득합니다.</li>\n</ol>\n<p>스트림에는 총 <strong>4가지 타입</strong>이 존재합니다.</p>\n<ol>\n<li>\n<p>키만 보기</p>\n<p>DynamoDB의 <strong>키(HachKey/SortKey)값</strong>만 Stream으로 전송합니다.</p>\n</li>\n<li>\n<p>새 이미지</p>\n<p>새롭게 수정된 레코드 내용을 Stream으로 전송합니다.</p>\n</li>\n<li>\n<p>이전 이미지</p>\n<p>기존 레코드 내용만 Stream으로 전송합니다.</p>\n</li>\n<li>\n<p>새 이미지와 이전 이미지</p>\n<p>변경된 내용과 이전 내용이 모두 Stream으로 전송됩니다.</p>\n</li>\n</ol>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1200px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 42.66666666666667%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAABYlAAAWJQFJUiTwAAABXUlEQVQoz51Q2U6EQBDkh/0Wf8AXf8EnfTIxIQbd3eiKuAzXAiLHcGdZwrVleuDBGGOinVR6qqenunokZ+/ibcew0xl0ZsK0HJiW/ScYpgXSub2TIXmuC1mWoSgKTMNA0zQoyxJVVaGuKpF/Rolq6cuyDDxJoDyuITWHA9I0RZ7n4rIoCiFIoBrxoiiXPOO7eFGWaNvjLAgASZIgiiL0XYcwDMUjGuL7vuCcc3ieJ85BEKBtW/wUzy/aLDiOoyjUhyMYM+A4DmzbhqZpsCwLjDFsNhvBdV0XrqZpQt/3GIYBXdctgq+zIF1SBHmHj4gjjiPhilzT/5AzAm1CdXJPIB7Hsegj4a26OKRJ5JL+gfI4TQI0iPi0nKcvNcJpmu+GYd7waavOgv+JbjyhOI44v/Fxdqnhwe1gsh2kuq7BaYUsQ5pmiJMU72Ey81/AqZenuLo3cXGtQt1zrFZrfAKEo6Ti/A6aLwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"lambda3\"\n        title=\"lambda3\"\n        src=\"/static/9b3dc69ab30c98b349ec723f34444787/c1b63/lambda3.png\"\n        srcset=\"/static/9b3dc69ab30c98b349ec723f34444787/5a46d/lambda3.png 300w,\n/static/9b3dc69ab30c98b349ec723f34444787/0a47e/lambda3.png 600w,\n/static/9b3dc69ab30c98b349ec723f34444787/c1b63/lambda3.png 1200w,\n/static/9b3dc69ab30c98b349ec723f34444787/afa26/lambda3.png 1258w\"\n        sizes=\"(max-width: 1200px) 100vw, 1200px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<ol start=\"4\">\n<li>생성된 ARN을 바탕으로 Lambda트리거 세팅을 합니다.</li>\n</ol>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1200px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 22.666666666666664%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAABYlAAAWJQFJUiTwAAAApElEQVQY05WQwQqDMBBE8/8f0kNpL0JpD/2GnnoKkZyEoBHURFTYzJTtqbfqwGNhYGHfmrZtGWP80nUdQgjIOZNkASBHMX3fs65rhhA4jiNTSlyWBSLCUgoBHMJM00TnHJum4TAMiDFCr57n+UXyBOBK8rKDM8nKrOuqy9y2TSecc7DW0lr79t5XIvIgeQfwjxuAp+FPVDGnpNpQdf2ldhrV2ZMPUht+rkNFDW0AAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"lambda4\"\n        title=\"lambda4\"\n        src=\"/static/4d4588d0a03360cad121aa22f1e55e17/c1b63/lambda4.png\"\n        srcset=\"/static/4d4588d0a03360cad121aa22f1e55e17/5a46d/lambda4.png 300w,\n/static/4d4588d0a03360cad121aa22f1e55e17/0a47e/lambda4.png 600w,\n/static/4d4588d0a03360cad121aa22f1e55e17/c1b63/lambda4.png 1200w,\n/static/4d4588d0a03360cad121aa22f1e55e17/e7aec/lambda4.png 1726w\"\n        sizes=\"(max-width: 1200px) 100vw, 1200px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<hr>\n<h2 id=\"lambda-세팅\" style=\"position:relative;\"><a href=\"#lambda-%EC%84%B8%ED%8C%85\" aria-label=\"lambda 세팅 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Lambda 세팅</h2>\n<p><a href=\"https://www.serverless.com/\">Serverless Framework</a>를 통해 환경 세팅을 했습니다.</p>\n<p>배포하면 자동으로 관련된 Role을 생성해주기 때문에 Console 내 작업은 더 이상 하지 않았습니다.</p>\n<ol>\n<li>serverless.yml 세팅</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\">  <span class=\"token key atrule\">functions</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">main</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">handler</span><span class=\"token punctuation\">:</span> main.handler\n    <span class=\"token key atrule\">events</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">stream</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">arn</span><span class=\"token punctuation\">:</span> arn<span class=\"token punctuation\">:</span>aws<span class=\"token punctuation\">...</span> <span class=\"token comment\"># 뒤쪽 타임스탬프까지 모두 입력</span>\n          <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> dynamodb\n          <span class=\"token key atrule\">batchSize</span><span class=\"token punctuation\">:</span> <span class=\"token number\">100</span>\n    <span class=\"token key atrule\">memorySize</span><span class=\"token punctuation\">:</span> <span class=\"token number\">256</span>\n    <span class=\"token key atrule\">timeout</span><span class=\"token punctuation\">:</span> <span class=\"token number\">180</span> </code></pre></div>\n<ol start=\"2\">\n<li>\n<p>Serverless Framework에서 제공하는 플로우대로 배포를 합니다.</p>\n<p>배포 완료 후 Console을 통해 확인하면 DynamoDB와 연결된 내용을 확인 할 수 있습니다.</p>\n</li>\n</ol>\n<p><strong>DynamoDB의 트리거</strong></p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1200px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 27.333333333333332%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAABYlAAAWJQFJUiTwAAAA8UlEQVQY041Pu07DQBD0HyPRUtDS8glBIg0togplilAhxTIGhLCV+Ei4l+XDPps776A7gjAdI412drTa3Ukuljsczx/Ho/mLO18wZ1vjpFReSIm+78kYQ0opeO/xHyTrVz7erJ5xvXzAXbZBrTWEEJBCkJQyas45GGOo6zoy6KpiaJoGxpjoaa1jTexHA73f3hdP69l7VV69MXa5qdhiu+NQSoWlFIbzPEdRFMFDlmVI0xRlWUYvHAzHAxPnPEbCLYATAGcATj89zbohRqQDYa1F13Ux1jAMsW/bNn5IRL+RAYzBmPKwg/5635jqKX7mvgA2h3nVU1rk7gAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"lambda5\"\n        title=\"lambda5\"\n        src=\"/static/9aeafb6b7d4327efa42e0f7521799f56/c1b63/lambda5.png\"\n        srcset=\"/static/9aeafb6b7d4327efa42e0f7521799f56/5a46d/lambda5.png 300w,\n/static/9aeafb6b7d4327efa42e0f7521799f56/0a47e/lambda5.png 600w,\n/static/9aeafb6b7d4327efa42e0f7521799f56/c1b63/lambda5.png 1200w,\n/static/9aeafb6b7d4327efa42e0f7521799f56/d4b10/lambda5.png 1394w\"\n        sizes=\"(max-width: 1200px) 100vw, 1200px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p><strong>Lambda의 트리거</strong></p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1200px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 17.666666666666668%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAYAAACOXx+WAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAnUlEQVQY01VQyQ3DMAzz/jN0ks4SFOincdDmhq3DslQ4B+I8CPJDipRjZiMqoBPKKevYNvb17+ec7PEZZt8twSbKeUSxEdiQyHbvnR0AbiKltINZRUTnqbff0HsUfa1AsAJZZNHAYkvEW9CpEdFc67tNiMgVmpJJziqSzyPGTMrFeJivVldgBDAXQqznbpMP1FqpBDDvXLUq76on/wEd4TdDsFllRAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"lambda6\"\n        title=\"lambda6\"\n        src=\"/static/b063d51e0e1c9858a6a81a7db580d5e0/c1b63/lambda6.png\"\n        srcset=\"/static/b063d51e0e1c9858a6a81a7db580d5e0/5a46d/lambda6.png 300w,\n/static/b063d51e0e1c9858a6a81a7db580d5e0/0a47e/lambda6.png 600w,\n/static/b063d51e0e1c9858a6a81a7db580d5e0/c1b63/lambda6.png 1200w,\n/static/b063d51e0e1c9858a6a81a7db580d5e0/d61c2/lambda6.png 1800w,\n/static/b063d51e0e1c9858a6a81a7db580d5e0/97a96/lambda6.png 2400w,\n/static/b063d51e0e1c9858a6a81a7db580d5e0/989f9/lambda6.png 3178w\"\n        sizes=\"(max-width: 1200px) 100vw, 1200px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<ol start=\"3\">\n<li>위와 같이 세팅이 완료되면 준비는 끝났습니다.</li>\n</ol>\n<p>이후 DynamoDB의 레코드에 특정 이벤트가 발생하면 Lambda함수로 Event가 전송됩니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n  Records<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n    <span class=\"token punctuation\">{</span>\n      eventID<span class=\"token operator\">:</span> '...'<span class=\"token punctuation\">,</span>\n      eventName<span class=\"token operator\">:</span> 'INSERT'<span class=\"token punctuation\">,</span>\n      eventVersion<span class=\"token operator\">:</span> '<span class=\"token number\">1.1</span>'<span class=\"token punctuation\">,</span>\n      eventSource<span class=\"token operator\">:</span> 'aws<span class=\"token operator\">:</span>dynamodb'<span class=\"token punctuation\">,</span>\n      awsRegion<span class=\"token operator\">:</span> '...'<span class=\"token punctuation\">,</span>\n      dynamodb<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n        ApproximateCreationDateTime<span class=\"token operator\">:</span> <span class=\"token number\">1613373723</span><span class=\"token punctuation\">,</span>\n        Keys<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> content<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> S<span class=\"token operator\">:</span> '테스트' <span class=\"token punctuation\">}</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        NewImage<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> ttl<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> N<span class=\"token operator\">:</span> '<span class=\"token number\">1613373820</span>' <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> content<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> S<span class=\"token operator\">:</span> '테스트' <span class=\"token punctuation\">}</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        SequenceNumber<span class=\"token operator\">:</span> '<span class=\"token number\">4500000000033167407696</span>'<span class=\"token punctuation\">,</span>\n        SizeBytes<span class=\"token operator\">:</span> <span class=\"token number\">41</span><span class=\"token punctuation\">,</span>\n        StreamViewType<span class=\"token operator\">:</span> 'NEW_AND_OLD_IMAGES'\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n      eventSourceARN<span class=\"token operator\">:</span> 'arn<span class=\"token operator\">:</span>aws<span class=\"token operator\">:</span>...'\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">{</span>\n      eventID<span class=\"token operator\">:</span> '...'<span class=\"token punctuation\">,</span>\n      eventName<span class=\"token operator\">:</span> 'REMOVE'<span class=\"token punctuation\">,</span>\n      eventVersion<span class=\"token operator\">:</span> '<span class=\"token number\">1.1</span>'<span class=\"token punctuation\">,</span>\n      eventSource<span class=\"token operator\">:</span> 'aws<span class=\"token operator\">:</span>dynamodb'<span class=\"token punctuation\">,</span>\n      awsRegion<span class=\"token operator\">:</span> '...'<span class=\"token punctuation\">,</span>\n      dynamodb<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n        ApproximateCreationDateTime<span class=\"token operator\">:</span> <span class=\"token number\">1613373723</span><span class=\"token punctuation\">,</span>\n        Keys<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> content<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> S<span class=\"token operator\">:</span> '테스트' <span class=\"token punctuation\">}</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        NewImage<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> ttl<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> N<span class=\"token operator\">:</span> '<span class=\"token number\">1613373820</span>' <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> content<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> S<span class=\"token operator\">:</span> '테스트' <span class=\"token punctuation\">}</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        SequenceNumber<span class=\"token operator\">:</span> '<span class=\"token number\">4500000000033167407696</span>'<span class=\"token punctuation\">,</span>\n        SizeBytes<span class=\"token operator\">:</span> <span class=\"token number\">41</span><span class=\"token punctuation\">,</span>\n        StreamViewType<span class=\"token operator\">:</span> 'NEW_AND_OLD_IMAGES'\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n      eventSourceARN<span class=\"token operator\">:</span> 'arn<span class=\"token operator\">:</span>aws<span class=\"token operator\">:</span>dynamodb<span class=\"token operator\">:</span>...'\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    ...\n  <span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Record는 배열이며 동시간대 발생하는 다수의 이벤트들이 함께 들어옵니다.</p>\n<p><strong>eventName객체</strong>는 <code class=\"language-text\">INSERT</code>, <code class=\"language-text\">REMOVE</code>, <code class=\"language-text\">MODIFY</code> 등이 있으며, <strong>dynamodb객체</strong>에 실제 레코드 정보가 담겨 있습니다.</p>\n<hr>\n<h2 id=\"주의점\" style=\"position:relative;\"><a href=\"#%EC%A3%BC%EC%9D%98%EC%A0%90\" aria-label=\"주의점 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>주의점</h2>\n<p>무작정 TTL의 장점만을 보고 사용하기에는 주의해야 할 사항들이 존재합니다.</p>\n<ol>\n<li>\n<p>TTL 속성에 숫자 데이터 형식을 사용해야 합니다. 다른 데이터 형식(예: 문자열)은 지원되지 않습니다.</p>\n</li>\n<li>\n<p>TTL 속성은 Epoch 시간 형식을 사용해야 합니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\">Linux Terminal<span class=\"token operator\">:</span> date +%s\n\nPython<span class=\"token operator\">:</span> import time; int(time.time())\n\nJava<span class=\"token operator\">:</span> System.currentTimeMillis() / 1000L\n\nJavaScript<span class=\"token operator\">:</span> Math.floor(Date.now() / <span class=\"token number\">1000</span>)</code></pre></div>\n</li>\n<li>\n<p>DynamoDB가 항목을 삭제할 때까지 최소 48시간 동안 기다립니다.</p>\n</li>\n<li>\n<p>만료 날짜는 5년을 넘지 않아야 합니다.</p>\n</li>\n</ol>\n<p><strong>Lambda로 전송된 스트림은 온전하게 끝나지 않는다면 Failover를 계속 수행합니다.</strong></p>\n<p><strong>이는 장점이 될 수도 있지만, 무한실행이라는 치명적인 오류를 가져옵니다.</strong></p>\n<p>적절한 Lambda함수 처리가 필요합니다.</p>\n<hr>\n<h2 id=\"reference\" style=\"position:relative;\"><a href=\"#reference\" aria-label=\"reference permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Reference</h2>\n<ul>\n<li>\n<p><a href=\"https://docs.aws.amazon.com/amazondynamodb/latest/developerguide/TTL.html\">DynamoDB TTL</a></p>\n</li>\n<li>\n<p><a href=\"https://aws.amazon.com/ko/premiumsupport/knowledge-center/dynamodb-ttl-items-not-deleted/\">TTL 특징</a></p>\n</li>\n</ul>","fields":{"slug":"/dynamo-db/about_dynamodb_ttl/"},"frontmatter":{"title":"TTL을 이용한 DynamoDB Stream Trigger","series_num":0,"date":"Feb 18. 2021","tags":["AWS","DynamoDB","Event Stream","TTL","Lambda","Serverless"]},"headings":[{"value":"Data Modeling","depth":2,"id":"data-modeling"},{"value":"Storage","depth":2,"id":"storage"},{"value":"TTL (Time To Live)","depth":2,"id":"ttl-time-to-live"},{"value":"DynamoDB 세팅","depth":2,"id":"dynamodb-세팅"},{"value":"Lambda 세팅","depth":2,"id":"lambda-세팅"},{"value":"주의점","depth":2,"id":"주의점"},{"value":"Reference","depth":2,"id":"reference"}]},"related":{"nodes":[]}},"pageContext":{"id":"77e413b3-d3cf-5c5d-9835-adca79ee9f80","slug":"/dynamo-db/about_dynamodb_ttl/","series_name":"","category":null,"previous":{"fields":{"slug":"/architecture/about_event_driven_architecture/"},"frontmatter":{"title":"EDA(Event Driven Architecture)이란?"}},"next":{"fields":{"slug":"/architecture/about_msa/"},"frontmatter":{"title":"MSA(Microservice Architecture)이란?"}}}},"staticQueryHashes":["1069093791","1381152472","1821008744","278901532","3528274121"]}